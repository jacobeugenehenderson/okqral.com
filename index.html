<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🤠 okQRal – Prototype</title>

<script>
(function () {
  const ls = localStorage.getItem('theme');                 // 'dark' | 'light' | null
  const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const dark = ls ? (ls === 'dark') : sysDark;              // default: follow system

  const root = document.documentElement;
  root.classList.toggle('dark',  dark);                     // Tailwind dark: variants
  root.classList.toggle('light', !dark);                    // your theme.css :root.light
})();
</script>

  <!-- Fonts & Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
 
 <script>
  // Use class strategy so toggling `.dark` works
  tailwind.config = { darkMode: 'class' };
</script>
 
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Your stylesheet -->
  <link rel="stylesheet" href="./styles/theme.css">
</head>

<body class="theme-grid min-h-screen text-neutral-900 dark:text-neutral-100">

  <!-- HEADER (full-width, sticky) -->
  <header class="header-bar sticky top-0 z-30 bg-white/90 dark:bg-neutral-900/90 backdrop-blur border-b border-neutral-200 dark:border-neutral-800">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-8">
      <h1 class="text-lg font-semibold tracking-tight">
        <a href="./index.html" class="hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-500">
    🤠 okQRal
  </a>
</h1>

      <!-- Controls (right-aligned) -->
      <div class="ml-auto flex items-center gap-3" id="topControls">
        <!-- Type -->
        <label class="text-sm">
          <span class="sr-only">Type</span>
          <select id="qrType" class="topctl topctl--chev text-sm" aria-label="Type">
            <option>URL</option><option>Payment</option><option>WiFi</option>
            <option>Contact</option><option>Message</option><option>Event</option><option>Map</option>
          </select>
        </label>

        <!-- ECC -->
        <label class="text-sm">
          <span class="sr-only">ECC</span>
          <select id="ecc" class="topctl topctl--chev text-sm" aria-label="ECC">
            <option>L</option><option selected>M</option><option>Q</option><option>H</option>
          </select>
        </label>

        <!-- Menu -->
        <div id="appMenuWrap" class="relative">
          <button id="appMenuBtn" class="topctl topctl--chev text-sm"
                  aria-haspopup="menu" aria-expanded="false" aria-controls="appMenu">
            Menu
          </button>
          <div id="appMenu"
               class="hidden absolute right-0 mt-2 w-56 rounded-lg border border-neutral-200 bg-white shadow-md
                      dark:bg-neutral-800 dark:border-neutral-700"
               role="menu" aria-labelledby="appMenuBtn">
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 dark:hover:bg-neutral-700"
                    role="menuitem" data-open="aboutApp">About this app</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 dark:hover:bg-neutral-700"
                    role="menuitem" data-open="aboutQR">About QR Codes</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 dark:hover:bg-neutral-700"
                    role="menuitem" data-open="privacy">Privacy</button>
            <button class="w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 dark:hover:bg-neutral-700"
                    role="menuitem" data-open="legal">Legal / Disclaimer</button>
            <button id="themeToggle" type="button"
                    onclick="setTheme(document.documentElement.classList.contains('dark') ? 'light' : 'dark')">
                    <span class="mi">🌙</span><span>Toggle Dark Mode</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-6 py-8 grid grid-cols-1 md:grid-cols-2 items-start gap-10">


<!-- LEFT: Preview Stage -->
<section class="stage-stick self-start flex justify-center">
  <!-- Own the iPhone aspect ratio here -->
  <div class="relative w-full max-w-[360px] mx-auto overflow-visible aspect-[1/1.15]">
    <div class="absolute inset-0 px-4 pb-4 pt-0">
      <!-- Single card: stroke/fill live here; SVG stays transparent -->
      <div id="qrPreview" class="w-full h-full rounded-xl overflow-visible flex flex-col">
        <!-- live SVG mounts here -->
        <div id="qrMount" class="flex-1 min-h-[200px] grid justify-items-center items-start w-full"></div>
      </div>

      <!-- Previous and Next Arrows -->
    <button id="prevSubtype" class="nav-arrow absolute w-10 h-10 grid place-items-center"></button>

    <button id="nextSubtype" class="nav-arrow absolute w-10 h-10 grid place-items-center"></button>
    </div>
  </div>
</section>

<!-- RIGHT: Stepper (controls) -->
<section id="stepper"
  class="stage-stick space-y-4 w-full max-w-[560px] mx-auto justify-self-center">

  <!-- Caption -->
  <div class="step-card rounded-2xl border border-neutral-200 bg-white overflow-hidden dark:bg-neutral-900 dark:border-neutral-800"
       data-step="caption">
    <button class="w-full step-header px-4 py-3 text-left font-medium" data-step-toggle>
      Caption
    </button>
    <div class="px-4 pb-4 space-y-3" data-step-panel>
      <label class="block text-sm">
        <textarea id="campaign"
          rows="2"
          class="w-full rounded-md border px-3 py-2"
          placeholder="ENGAGE"></textarea>
      </label>
      <label class="inline-flex items-center gap-2">
        <input id="showCaption" type="checkbox" class="rounded border" checked />
        <span class="text-sm">Show caption under preview</span>
      </label>
    </div>
  </div>

<!-- Design -->
<div class="step-card rounded-2xl border border-neutral-200 bg-white dark:bg-neutral-900 dark:border-neutral-800"
     data-step="design">
  <button class="w-full step-header px-4 py-3 text-left font-medium" data-step-toggle>
    Design
  </button>

  <!-- Closed by default -->
  <div class="px-4 pb-4 space-y-4" data-step-panel style="display:none">
    <!-- Color quadrant -->
    <div class="grid gap-3 sm:grid-cols-2">
      <!-- Caption Text Color -->
      <label class="text-sm">
        <span class="block mb-1">Caption Text Color</span>
        <div class="flex items-center gap-2">
          <input id="captionColor" type="color" class="h-9 w-10 rounded-md border" value="#000000" />
          <input id="captionColorHex" type="text" class="flex-1 rounded-md border px-3 py-2 text-sm" placeholder="#RRGGBB" />
        </div>
      </label>

      <!-- Body -->
      <label class="text-sm">
        <span class="block mb-1">Body</span>
        <div class="flex items-center gap-2">
          <input id="bodyColor" type="color" class="h-9 w-10 rounded-md border" value="#000000" />
          <input id="bodyColorHex" type="text" class="flex-1 rounded-md border px-3 py-2 text-sm" placeholder="#RRGGBB" />
        </div>
      </label>

      <!-- Eye Ring -->
      <label class="text-sm">
        <span class="block mb-1">Eye Ring</span>
        <div class="flex items-center gap-2">
          <input id="eyeRingColor" type="color" class="h-9 w-10 rounded-md border" value="#9CA3AF" />
          <input id="eyeRingColorHex" type="text" class="flex-1 rounded-md border px-3 py-2 text-sm" placeholder="#RRGGBB" />
        </div>
      </label>

      <!-- Eye Center -->
      <label class="text-sm">
        <span class="block mb-1">Eye Center</span>
        <div class="flex items-center gap-2">
          <input id="eyeCenterColor" type="color" class="h-9 w-10 rounded-md border" value="#6B7280" />
          <input id="eyeCenterColorHex" type="text" class="flex-1 rounded-md border px-3 py-2 text-sm" placeholder="#RRGGBB" />
        </div>
      </label>
    </div>

    <!-- Shapes -->
    <div class="grid gap-3 sm:grid-cols-3">
      <label class="text-sm">
        <span class="block mb-1">Modules</span>
        <select id="moduleShape" class="w-full rounded-md border px-3 py-2">
          <option>Square</option><option>Rounded</option><option>Circle</option>
        </select>
      </label>
      <label class="text-sm">
        <span class="block mb-1">Eye Ring</span>
        <select id="eyeRingShape" class="w-full rounded-md border px-3 py-2">
          <option>Square</option><option>Rounded</option><option>Circle</option>
        </select>
      </label>
      <label class="text-sm">
        <span class="block mb-1">Eye Center</span>
        <select id="eyeCenterShape" class="w-full rounded-md border px-3 py-2">
          <option>Square</option><option>Rounded</option><option>Circle</option>
        </select>
      </label>
    </div>

    <!-- Module fill -->
    <div class="grid gap-3 sm:grid-cols-3">
      <label class="text-sm">
        <span class="block mb-1">Module Fill</span>
        <select id="modulesMode" class="w-full rounded-md border px-3 py-2">
          <option>Shape</option><option>Emoji</option>
        </select>
      </label>
      <label class="text-sm" id="modulesEmojiWrap">
        <span class="block mb-1">Emoji</span>
        <div class="flex gap-2">
          <input id="modulesEmoji" type="text" class="w-full rounded-md border px-3 py-2" value="😀" />
          <button type="button" data-emoji-target="modulesEmoji" class="px-3 py-2 text-sm rounded-md border hover:bg-neutral-50">Pick…</button>
        </div>
      </label>
      <label class="text-sm" id="modulesScaleWrap">
        <span class="block mb-1">Scale</span>
        <div class="flex items-center gap-2">
          <input id="modulesScale" type="number" step="0.05" min="0.1" max="1" class="w-full rounded-md border px-3 py-2" value="0.9" />
        </div>
      </label>
    </div>

    <!-- Center content -->
    <div class="grid gap-3 sm:grid-cols-3 items-start">
      <label class="text-sm">
        <span class="block mb-1">Center content</span>
        <select id="centerMode" class="w-full rounded-md border px-3 py-2">
          <option>None</option>
          <option>Blank</option>
          <option>Emoji</option>
        </select>
      </label>
      <label class="text-sm" id="centerEmojiWrap">
        <span class="block mb-1">Emoji</span>
        <div class="flex gap-2">
          <input id="centerEmoji" type="text" class="w-full rounded-md border px-3 py-2" value="😊" />
          <button type="button" data-emoji-target="centerEmoji" class="px-3 py-2 text-sm rounded-md border hover:bg-neutral-50">Pick…</button>
        </div>
      </label>
      <label class="text-sm" id="centerScaleWrap">
        <span class="block mb-1">Scale</span>
        <div class="flex items-center gap-2">
          <input id="centerScale" type="number" step="0.05" min="0.1" max="1.5" class="w-full rounded-md border px-3 py-2" value="1" />
        </div>
      </label>
    </div>

    <!-- Background (last) -->
    <div class="grid grid-cols-[auto,1fr,auto] items-center gap-3">
      <span class="text-sm">Background</span>
      <div class="flex items-center gap-2">
        <input id="bgColor" type="color" class="h-9 w-10 rounded-md border" value="#FFFFFF" />
        <input id="bgColorHex" type="text" class="flex-1 rounded-md border px-3 py-2 text-sm" placeholder="#RRGGBB" />
      </div>
      <label class="inline-flex items-center gap-2">
        <input id="bgTransparent" type="checkbox" class="rounded border" />
        <span class="text-sm">Transparent</span>
      </label>
    </div>
  </div>
</div>

<!-- Mechanicals -->
<div class="step-card rounded-2xl border border-neutral-200 bg-white dark:bg-neutral-900 dark:border-neutral-800"
     data-step="mechanicals">
  <button class="w-full step-header px-4 py-3 text-left font-medium" data-step-toggle>
    Mechanicals
  </button>
  <!-- Closed by default -->
  <div class="px-4 pb-4 space-y-4" data-step-panel style="display:none">
    <div id="detailsPanel" class="space-y-4"></div>
  </div>
</div>

<!-- Finish -->
<div id="finishCard"
     class="step-card rounded-2xl border border-neutral-200 bg-white dark:bg-neutral-900 dark:border-neutral-800"
     data-step="finish">
  <button type="button"
          class="w-full step-header px-4 py-3 text-left font-medium"
          data-step-toggle>
    Finish
  </button>

  <div class="px-4 pb-4 space-y-3" data-step-panel>
    <div class="flex flex-wrap items-center gap-3">
      <label class="inline-flex items-center gap-2">
        <input id="wantPng" type="checkbox" class="rounded border" checked>
        <span class="text-sm">PNG</span>
      </label>

      <label class="inline-flex items-center gap-2">
        <input id="wantSvg" type="checkbox" class="rounded border" checked>
        <span class="text-sm">SVG</span>
      </label>

      <button id="exportBtn" type="button"
              class="ml-auto px-4 py-2 rounded-lg bg-black text-white text-sm">
        Generate
      </button>
    </div>
  </div>
</div>

  <!-- Emoji Modal -->
  <div id="emojiModal" class="hidden fixed inset-0 z-50 modal-bg grid place-items-center p-4">
    <div class="w-full max-w-3xl rounded-2xl bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 shadow-lg">
      <div class="flex items-center gap-3 px-4 py-3 border-b dark:border-neutral-800">
        <div class="text-sm font-medium">Pick an emoji</div>
        <input id="emojiSearch" type="text" placeholder="Search…" class="ml-auto w-64 rounded-md border px-3 py-2 text-sm" />
        <button id="emojiClose" class="ml-2 px-3 py-2 rounded-md border text-sm hover:bg-neutral-50 dark:hover:bg-neutral-800">Close</button>
      </div>
      <div class="max-h-[60vh] overflow-auto p-4">
        <div id="emojiGrid" class="grid emoji-grid gap-2"></div>
      </div>
    </div>
  </div>

</main>

  <footer class="app-footer">
    <div class="app-footer__rule"></div>
    <p class="app-footer__text">© <span id="year"></span> 🤠 okQRal by Jacob Eugene Henderson. All rights reserved.</p>
  </footer>

<script>
(function () {
  const root = document.documentElement;

  function apply(isDark, persist=true){
    root.classList.remove('dark','light');
    root.classList.add(isDark ? 'dark' : 'light');
    if (persist) localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  // initial: saved choice → system preference
  const saved   = localStorage.getItem('theme');                  // 'dark' | 'light' | null
  const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  apply(saved ? saved === 'dark' : sysDark, /*persist=*/false);

  // click handler on the menu item
  document.getElementById('themeToggle')?.addEventListener('click', () => {
    const nextDark = !root.classList.contains('dark');
    apply(nextDark);
  }, { passive:true });

  // follow OS changes only if user hasn't chosen
  const mq = window.matchMedia('(prefers-color-scheme: dark)');
  mq.addEventListener?.('change', (e) => {
    if (!localStorage.getItem('theme')) apply(e.matches, /*persist=*/false);
  });
})();
</script>

<!-- Emoji Modal -->
<!-- (optional) tiny helper for the dim bg -->
<style>
  .modal-bg { background: rgba(0,0,0,.28); backdrop-filter: blur(2px); }
</style>

<!-- Your app code (keep this if you already have it) -->
<script src="./vendor/qrcode.min.js"></script>
<script src="./qr_app.js" defer></script>

<!-- Boot once both QRCode & render() are ready -->
<script>
  (function boot() {
    let tries = 0, max = 80;
    (function tick(){
      if (window.QRCode && QRCode.CorrectLevel && typeof window.render === "function") { render(); return; }
      if (++tries >= max) { console.error("QR library never loaded; check vendor/qrcode.min.js"); return; }
      setTimeout(tick, 50);
    })();
  })();
</script>

<!-- Emoji picker wiring -->
<script type="module">
  import 'https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js';

  const emojiModal  = document.getElementById('emojiModal');
  const emojiClose  = document.getElementById('emojiClose');
  let   emojiTarget = null;

  function openEmoji(targetId) {
    emojiTarget = document.getElementById(targetId) || null;
    emojiModal.classList.remove('hidden');
    queueMicrotask(() => document.querySelector('emoji-picker')?.focus());
  }
  function closeEmoji() {
    emojiModal.classList.add('hidden');
    emojiTarget = null;
    if (typeof window.render === 'function') window.render();
  }
  window.openEmoji  = openEmoji;
  window.closeEmoji = closeEmoji;

  document.querySelectorAll('[data-emoji-target]')
    .forEach(btn => btn.addEventListener('click', () => openEmoji(btn.getAttribute('data-emoji-target'))));
  emojiClose?.addEventListener('click', closeEmoji);
  emojiModal?.addEventListener('click', (e) => { if (e.target === emojiModal) closeEmoji(); });
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !emojiModal.classList.contains('hidden')) closeEmoji(); });

  // Insert picker and connect selection
  const grid   = document.getElementById('emojiGrid');
  const picker = document.createElement('emoji-picker');
  picker.setAttribute('emojis-per-row', '10');
  picker.setAttribute('skin-tone-emoji', '👍');
  picker.style.width = '100%';
  picker.style.maxHeight = '60vh';
  picker.style.border = '0';

  const applyPickerTheme = () => {
    picker.setAttribute('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
  };
  applyPickerTheme();
  document.getElementById('themeToggle')?.addEventListener('click', applyPickerTheme);
  window.matchMedia?.('(prefers-color-scheme: dark)').addEventListener?.('change', applyPickerTheme);

  grid.replaceWith(picker);

  picker.addEventListener('emoji-click', (e) => {
    const char = e.detail.unicode;
    if (emojiTarget) {
      emojiTarget.value = char;
      emojiTarget.dispatchEvent(new Event('input', { bubbles: true }));
    }
    closeEmoji();
  });
</script>

<script>
(() => {
  const cards   = Array.from(document.querySelectorAll('.step-card'));
  const toggles = Array.from(document.querySelectorAll('[data-step-toggle]'));
  const finish  = document.querySelector('.step-card[data-step="finish"]');

  function setFooterVar(){
    // Keep a live CSS var with the Finish bar height for max-height math
    const h = finish ? finish.offsetHeight : 0;
    document.documentElement.style.setProperty('--footer-h', (h || 72) + 'px');
  }

  function openCard(card){
  cards.forEach(c => {
    const open  = (c === card);
    const panel = c.querySelector('[data-step-panel]');
    const btn   = c.querySelector('[data-step-toggle]');
    c.classList.toggle('is-open', open);
    if (panel) panel.style.display = open ? '' : 'none';      // <-- show/hide
    if (btn)   btn.setAttribute('aria-expanded', String(open));
  });
  setFooterVar();
}

  // Wire up open-state marker (no cascade changes, just a class)
  toggles.forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.step-card');
      if (card) openCard(card);
    });
  });

  // On first paint: Caption should be open (per your current default)
  // If your markup already opens it, the next line is harmless:
  const caption = cards.find(c => c.dataset.step === 'caption') || cards[0];
  if (caption) openCard(caption);

  // Keep the var current if the user resizes
  window.addEventListener('resize', setFooterVar, { passive: true });
})();
</script>

<script>
(() => {
  const root       = document.documentElement;
  const stepper    = document.getElementById('stepper');
  const designCard = document.querySelector('.step-card[data-step="design"]');
  const finishCard = document.querySelector('.step-card[data-step="finish"]');
  const headerBar  = document.querySelector('.header-bar');
  const panel = (card) => card?.querySelector('[data-step-panel]');

  function measureDesignPanelHeight() {
    const p = panel(designCard);
    if (!p) return 0;
    const wasHidden = getComputedStyle(p).display === 'none';
    const restore = wasHidden ? {display:p.style.display,position:p.style.position,visibility:p.style.visibility} : null;
    if (wasHidden) { p.style.display=''; p.style.position='absolute'; p.style.visibility='hidden'; }
    const h = Math.round(p.getBoundingClientRect().height);
    if (wasHidden && restore){ p.style.display=restore.display; p.style.position=restore.position; p.style.visibility=restore.visibility; }
    return h;
  }

  function setParkVars(){
    const headerH = headerBar?.offsetHeight || 56;
    const designH = measureDesignPanelHeight() || 520;
    const maxInViewport = Math.max(240, Math.min(designH, window.innerHeight - headerH - 16));
    root.style.setProperty('--header-h', headerH + 'px');
    root.style.setProperty('--park-h',   maxInViewport + 'px');   // 👈 distance from top we “park” at
  }

  // keep it updated
  window.addEventListener('resize', setParkVars, { passive: true });
  const ro = new ResizeObserver(setParkVars);
  const dp = panel(designCard); if (dp) ro.observe(dp);
  stepper?.addEventListener('click',  () => setTimeout(setParkVars, 0));
  stepper?.addEventListener('input',  () => setTimeout(setParkVars, 0));
  stepper?.addEventListener('change', () => setTimeout(setParkVars, 0));

  // expose so your accordion script can nudge it after toggling
  window._setParkVars = setParkVars;

  setParkVars();
})();
</script>

<script>
  // Footer year
  (function(){ const y=document.getElementById('year'); if (y) y.textContent=new Date().getFullYear(); })();

  // Make Menu match selects in case CSS didn't load early enough
  document.getElementById('appMenuBtn')?.classList.add('control');

  // When you already compute transparency in render(), also toggle card classes:
  (function hookPreviewFrame(){
    const origRender = window.render;
    if (!origRender) return;
    window.render = function(){
      origRender();
      const preview = document.getElementById('qrPreview');
      if (!preview) return;
      const wantTransparent = !!document.getElementById('bgTransparent')?.checked;
      const frameColor = (document.getElementById('bgColor')?.value || '#A78BFA');
      preview.style.setProperty('--frame-color', frameColor);
      preview.style.setProperty('--frame-w', '2px');
      preview.classList.toggle('card--stroke', wantTransparent);
      preview.classList.toggle('card--fill', !wantTransparent);
    };
    // run once to apply class immediately
    window.render();
  })();

  // Ensure arrows are wired (safe no-ops if you have logic already)
  document.getElementById('prevSubtype')?.addEventListener('click', () => {
    if (window.cyclePreset) return window.cyclePreset(-1);
  });
  document.getElementById('nextSubtype')?.addEventListener('click', () => {
    if (window.cyclePreset) return window.cyclePreset(1);
  });
</script>

<!-- App menu toggle -->
<script>
  (function(){
    const btn = document.getElementById('appMenuBtn');
    const menu = document.getElementById('appMenu');
    if(!btn || !menu) return;

    const close = () => { 
      menu.classList.add('hidden'); 
      btn.setAttribute('aria-expanded','false'); 
    };
    const open  = () => { 
      menu.classList.remove('hidden'); 
      btn.setAttribute('aria-expanded','true'); 
    };

    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      if(menu.classList.contains('hidden')) open(); else close();
    });

    document.addEventListener('click', (e)=>{
      if(!menu.classList.contains('hidden') && 
          !document.getElementById('appMenuWrap')?.contains(e.target)) close();
    });

    document.addEventListener('keydown', (e)=>{ 
      if(e.key==='Escape') close(); 
    });
  })();
</script>

<script>
(function () {
  const onTab = e => { if (e.key === 'Tab') document.body.classList.add('kbd'); };
  const onMouse = () => document.body.classList.remove('kbd');
  window.addEventListener('keydown', onTab, { once: true });
  window.addEventListener('mousedown', onMouse);
})();
</script>

<script>
  // single source of truth for theme
  window.setTheme = function(mode /* 'dark' | 'light' */) {
    const r = document.documentElement;
    r.classList.remove('dark','light');
    r.classList.add(mode);
    localStorage.setItem('theme', mode);
  };

  // initialize on load: saved choice → system preference
  (function initTheme(){
    const saved = localStorage.getItem('theme');
    const sys = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    setTheme(saved || sys);
  })();
</script>

</body>
</html>